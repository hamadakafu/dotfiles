#!/bin/bash
# written by Shotaro Fujimoto
#=#=#=
# Convert a scanned pdf to the pdf file which contains the embedded
# transparent texts generated by OCR engine 'tesseract'.
#
# **Require**
#
# * tesseract
#     * [GitHub repository](https://github.com/tesseract-ocr/tesseract)
#     * Install with `apt` command
# ```
# sudo apt-get install tesseract-ocr tesseract-ocr-jpn
# ```
#
# * pdftk
# * pdftoppm
#
# **Usage**
#
# ```
# pdfocr foo.pdf
# ```
#
# **TODO**
#
# * receive some options
#=#=

set -exuo pipefail

readonly target="$1"
readonly target_noext="${1%.pdf}"
readonly tmpd=$(mktemp -d)

# pdftoppm
# - png
pdftoppm -png "${target}" "${tmpd}/page"
# - ppm
# pdftoppm "${target}" "${targetwithoutext}.d/page"

# tesseract
# - png
find "${tmpd}" -type f -name "*.png" | sed 's/\.png$//' | xargs -P8 -n1 -I% tesseract %.png % -l eng+jpn pdf
# - ppm
# find "./${tmpd}" -type f -name "*.ppm" | sed 's/\.ppm$//' | xargs -P8 -n1 -I% tesseract %.ppm % -l eng+jpn pdf

# Merge to one pdf file
pdftk "${tmpd}"/*.pdf cat output "${target_noext}-ocr.pdf"

# Clear
rm -r "${tmpd}"
